window.HardwareModule = window.HardwareModule || { ioInterval: null, pinData: null, signalData: null, init() { console.log("[Hardware] Initializing"), this.loadPinConfiguration(), this.setupEventListeners(), this.setupEventListeners() }, loadPinConfiguration() { fetch("/api/hardware/pins").then(e => e.json()).then(e => { console.log("[Hardware] Pin configuration loaded:", e), this.pinData = e.pins || [], this.signalData = e.signals || [], this.renderPinConfiguration(e), this.loadConfigValues() }).catch(e => { console.error("[Hardware] Failed to load pin configuration:", e), this.showStatus(window.i18n.t('hardware.load_failed'), "error") }) }, renderPinConfiguration(e) { console.log("[Hardware] Rendering pin configuration"); document.querySelectorAll(".pin-select").forEach(e => { if (e.disabled) return; const t = e.dataset.signal; if (e.innerHTML = '<option value="">' + window.i18n.t('hardware.select_pin') + '</option>', t && t.startsWith("output_")) for (let t = 1; t <= 16; t++) { const n = document.createElement("option"); n.value = 115 + t, n.textContent = `Y${t}`, e.appendChild(n) } else if (t && t.startsWith("input_")) for (let t = 1; t <= 16; t++) { const n = document.createElement("option"); n.value = 99 + t, n.textContent = `X${t}`, e.appendChild(n) } else this.pinData && this.pinData.length > 0 && this.pinData.filter(e => e.gpio < 100).forEach(t => { const n = document.createElement("option"); n.value = t.gpio, n.textContent = `${t.silk} (GPIO ${t.gpio})`, e.appendChild(n) }); if (this.signalData) { const n = this.signalData.find(e => e.key === t); n && n.current_pin && (e.value = n.current_pin) } if (!e.value) switch (t) { case "wj66_rx": e.value = 14; break; case "wj66_tx": e.value = 33; break; case "output_status_green": e.value = 124; break; case "output_status_yellow": e.value = 125; break; case "output_status_red": e.value = 126; break; case "output_buzzer": e.value = 127 } }) }, renderPinSummary() { const e = document.getElementById("pin-summary-table"); if (!e) return; document.getElementById("eth_enabled"), document.getElementById("lcd_enabled"), document.getElementById("vfd_enabled"), document.getElementById("jxk10_enabled"), document.getElementById("status_light_enabled"), document.getElementById("buzzer_enabled"); const t = [...Array.from({ length: 16 }, (e, t) => ({ label: `X${t + 1}`, type: "Digital Input", pin: 100 + t })), ...Array.from({ length: 16 }, (e, t) => ({ label: `Y${t + 1}`, type: "Digital Output", pin: 116 + t })), { label: "CH1", type: "4/20mA Input", pin: 36 }, { label: "CH2", type: "4/20mA Input", pin: 34 }, { label: "CH3", type: "0-5V Input", pin: 35 }, { label: "CH4", type: "0-5V Input", pin: 39 }, { label: "HT1", type: "Sensor/GPIO", pin: 14 }, { label: "HT2", type: "Sensor/GPIO", pin: 33 }, { label: "HT3", type: "Sensor/GPIO", pin: 32 }, { label: "RS485_A", type: "RS485", pin: 16 }, { label: "RS485_B", type: "RS485", pin: 13 }, { label: "I2C_SDA", type: "I2C", pin: 4 }, { label: "I2C_SCL", type: "I2C", pin: 5 }, { label: "433MHz_RX", type: "RF Input", pin: -1 }, { label: "433MHz_TX", type: "RF Output", pin: -1 }], n = new Map, a = (e, t) => { e < 0 || (n.has(e) || n.set(e, []), n.get(e).push(t)) }; this.signalData && this.signalData.forEach(e => { const t = void 0 !== e.current_pin ? e.current_pin : e.default_pin; void 0 !== t && a(t, e.name || e.key) }), a(23, "Ethernet MDC"), a(18, "Ethernet MDIO"), a(17, "Ethernet CLK/Pwr"), a(19, "Ethernet TXD0"), a(21, "Ethernet TX_EN"), a(22, "Ethernet TXD1"), a(25, "Ethernet RXD0"), a(26, "Ethernet RXD1"), a(27, "Ethernet CRS_DV"), a(4, "LCD Display (SDA)"), a(5, "LCD Display (SCL)"), a(16, "VFD (Altivar31) (RS485 A)"), a(13, "VFD (Altivar31) (RS485 B)"), a(16, "JXK-10 Current Monitor (RS485 A)"), a(13, "JXK-10 Current Monitor (RS485 B)"), a(16, "YH-TC05 Tachometer (RS485 A)"), a(13, "YH-TC05 Tachometer (RS485 B)"); let o = '\n            <table style="width: 100%; font-size: 12px; border-collapse: collapse;">\n                <thead>\n                    <tr style="background: var(--bg-secondary);">\n                        <th style="padding: 8px; text-align: left; width: 70px;">' + window.i18n.t('hardware.pin_label') + '</th>\n                        <th style="padding: 8px; text-align: left; width: 100px;">' + window.i18n.t('hardware.type') + '</th>\n                        <th style="padding: 8px; text-align: left;">' + window.i18n.t('hardware.connected_function') + '</th>\n                    </tr>\n                </thead>\n                <tbody>\n        '; t.forEach((e, t) => { const a = n.get(e.pin) || [], r = [...new Set(a)], d = r.length > 0 ? r.join(" + ") : "", i = (r.length, r.length > 0 ? "font-weight: 500; color: var(--text-primary);" : ""); o += `\n                    <td style="padding: 6px 8px; font-family: monospace; font-weight: bold; color: var(--accent-primary);">${e.label}</td>\n                    <td style="padding: 6px 8px;">${e.type}</td>\n                    <td style="padding: 6px 8px; ${i} white-space: normal; word-break: break-word;">${d || "-"}</td>\n                </tr>\n            ` }), o += "</tbody></table>", e.innerHTML = o }, getPinLabel(e) { if (null == e) return "--"; const t = this.pinData.find(t => t.gpio === e); return t ? t.silk || t.note || `GPIO ${e}` : e >= 100 && e <= 115 ? "X" + (e - 99) : e >= 116 && e <= 131 ? "Y" + (e - 115) : 36 === e ? "CH1" : 34 === e ? "CH2" : 35 === e ? "CH3" : 39 === e ? "CH4" : `GPIO ${e}` }, loadConfigValues() { fetch("/api/config").then(e => e.json()).then(e => { const t = document.getElementById("status_light_enabled"); t && (t.checked = 1 === e.status_light_en || "1" === e.status_light_en); const n = document.getElementById("eth_enabled"); n && (n.checked = 0 !== e.eth_en && "0" !== e.eth_en); const a = document.getElementById("lcd_enabled"); a && (a.checked = 0 !== e.lcd_en && "0" !== e.lcd_en); const o = document.getElementById("buzzer_enabled"); o && (o.checked = 0 !== e.buzzer_en && "0" !== e.buzzer_en); const r = document.getElementById("vfd_enabled"); r && (r.checked = 0 !== e.vfd_en && "0" !== e.vfd_en); const d = document.getElementById("vfd_addr"); d && e.vfd_addr && (d.value = e.vfd_addr); const i = document.getElementById("jxk10_enabled"); i && (i.checked = 0 !== e.jxk10_en && "0" !== e.jxk10_en); const s = document.getElementById("jxk10_addr"); s && e.jxk10_addr && (s.value = e.jxk10_addr); const l = document.getElementById("tach_enabled"); l && (l.checked = 0 !== e.yhtc05_en && "0" !== e.yhtc05_en); const c = document.getElementById("tach_addr"); c && e.yhtc05_addr && (c.value = e.yhtc05_addr); const u = document.getElementById("wj66_baud"); u && (u.value = e.encoder_baud || "9600"); const h = document.getElementById("rs485_baud"); h && (h.value = e.rs485_baud || "9600"); const v = document.getElementById("i2c_speed"); v && (v.value = e.i2c_speed || "100000"), this.renderPinSummary() }).catch(e => console.warn("[Hardware] Config load error:", e)) }, setupEventListeners() { const e = document.getElementById("btn-detect-baud"); e && (e.onclick = () => { e.textContent = window.i18n.t('hardware.detecting'), e.disabled = !0, fetch("/api/hardware/wj66/detect", { method: "POST" }).then(() => { window.Toast?.info(window.i18n.t('hardware.detect_started')), setTimeout(() => location.reload(), 8e3) }).catch(() => { window.Toast?.error(window.i18n.t('hardware.detect_failed')), e.textContent = "Detect", e.disabled = !1 }) }); const t = document.getElementById("btn-detect-rs485"); t && (t.onclick = () => { const e = document.getElementById("vfd_enabled")?.checked, n = document.getElementById("jxk10_enabled")?.checked; e || n ? (t.textContent = window.i18n.t('hardware.searching'), t.disabled = !0, window.Toast?.info(window.i18n.t('hardware.scanning')), fetch("/api/config/detect-rs485", { method: "POST" }).then(e => e.json()).then(e => { if (e.success) { window.Toast?.success(window.i18n.t('hardware.found_modbus').replace('{baud}', e.baud)); const t = document.getElementById("rs485_baud"); t && (t.value = e.baud) } else window.Toast?.error(e.error || window.i18n.t('hardware.detect_failed')) }).catch(() => window.Toast?.error(window.i18n.t('hardware.comm_error'))).finally(() => { t.textContent = "Detect", t.disabled = !1 })) : window.Toast?.error(window.i18n.t('hardware.enable_rs485_first')) }); const n = document.getElementById("save-config-btn"); n && (n.onclick = () => this.saveConfiguration()); const a = document.getElementById("reload-config-btn"); a && (a.onclick = () => { this.loadPinConfiguration(), this.showStatus(window.i18n.t('hardware.reloaded'), "info") }); const o = document.getElementById("reset-defaults-btn"); o && (o.onclick = () => this.resetConfiguration()); const p = document.getElementById("btn-test-i2c"); p && (p.onclick = () => { p.textContent = window.i18n.t('hardware.i2c_testing'), p.disabled = !0, fetch("/api/hardware/i2c/test", { method: "POST" }).then(e => e.json()).then(e => { e.success ? window.Toast?.success(window.i18n.t('hardware.i2c_test_success') + " @ " + e.address) : window.Toast?.error(window.i18n.t('hardware.i2c_test_failed')) }).catch(() => window.Toast?.error(window.i18n.t('hardware.i2c_test_failed'))).finally(() => { p.textContent = window.i18n.t('hardware.test_i2c'), p.disabled = !1 }) }) }, saveConfiguration() { console.log("[Hardware] Saving configuration..."), this.showStatus(window.i18n.t('hardware.saving'), "info"); const e = document.getElementById("vfd_enabled")?.checked, t = document.getElementById("jxk10_enabled")?.checked, n = parseInt(document.getElementById("vfd_addr")?.value || 0), a = parseInt(document.getElementById("jxk10_addr")?.value || 0); if (e && t && n === a) return void this.showStatus(window.i18n.t('hardware.addr_error'), "error"); const o = {}; document.querySelectorAll(".pin-select").forEach(e => { e.dataset.signal && e.value && !e.disabled && (o[e.dataset.signal] = parseInt(e.value)) }); const r = {}; document.querySelectorAll("[data-config]").forEach(e => { "checkbox" === e.type ? r[e.dataset.config] = e.checked ? 1 : 0 : "number" === e.type ? r[e.dataset.config] = parseInt(e.value) || 0 : r[e.dataset.config] = e.value }), document.querySelectorAll("select[data-config]").forEach(e => { r[e.dataset.config] = e.value }), fetch("/api/hardware/pins", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(o) }).then(e => e.json()).then(e => { if (e.success || e.ok) return this.saveConfigValues(r); throw new Error(e.error || "Save failed") }).then(() => { this.showStatus(window.i18n.t('hardware.reboot_notice'), "success") }).catch(e => { console.error("[Hardware] Save error:", e), this.showStatus(window.i18n.t('network.error_prefix') + e.message, "error") }) }, saveConfigValues: e => fetch("/api/config/batch", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(e) }).then(e => e.json()).then(e => (e.success || e.ok || console.error("[Hardware] Batch save error:", e.error), e)), resetConfiguration() { console.log("[Hardware] Resetting configuration..."), confirm(window.i18n.t('hardware.reset_confirm')) && (this.showStatus(window.i18n.t('hardware.resetting'), "info"), fetch("/api/hardware/pins/reset", { method: "POST" }).then(e => e.json()).then(e => { if (!e.success) throw new Error(e.error || "Reset failed"); this.showStatus(window.i18n.t('hardware.reset_success'), "success"), setTimeout(() => location.reload(), 3e3) }).catch(e => { console.error("[Hardware] Reset failed:", e), this.showStatus("Reset failed: " + e.message, "error") })) }, showStatus(e, t) { if (window.Toast) { const n = "error" === t ? 0 : 5e3; window.Toast.show(e, t, n) } else console.log(`[Hardware Status] ${t.toUpperCase()}: ${e}`) }, cleanup() { console.log("[Hardware] Cleaning up") } }, window.currentPageModule = window.HardwareModule;