!function(){class e{static executing=!1;static paused=!1;static currentLine=0;static telemetryHandler=null;static init(){console.log("[GCODE] Initializing"),this.setupEditor(),this.setupEventListeners(),this.updateParserState(),this.initQueueUI()}static setupEditor(){const e=document.getElementById("gcode-input"),t=document.getElementById("line-numbers");e&&t&&(this.inputHandler=()=>this.updateLineNumbers(),e.addEventListener("input",this.inputHandler),this.scrollHandler=()=>{t.scrollTop=e.scrollTop},e.addEventListener("scroll",this.scrollHandler),this.updateLineNumbers())}static updateLineNumbers(){const e=document.getElementById("gcode-input"),t=document.getElementById("line-numbers");if(!e||!t)return;const n=e.value.split("\n").length;let i="";for(let e=1;e<=n;e++)i+=e+"\n";t.textContent=i}static setupEventListeners(){document.getElementById("send-command")?.addEventListener("click",()=>{this.executeCurrentCommand()}),document.getElementById("send-all")?.addEventListener("click",()=>{this.executeAllCommands()}),document.getElementById("pause-execution")?.addEventListener("click",()=>{this.paused=!this.paused;const e=document.getElementById("pause-execution");e&&(e.querySelector("span").textContent=this.paused?"â–¶ï¸ Resume":"â¸ï¸ Pause")}),document.getElementById("stop-execution")?.addEventListener("click",()=>{this.stopExecution()}),document.getElementById("clear-editor")?.addEventListener("click",()=>{const e=document.getElementById("gcode-input");e&&(e.value="",this.updateLineNumbers())}),document.getElementById("load-examples")?.addEventListener("click",()=>{this.loadExamples()}),document.querySelectorAll("[data-quick]").forEach(e=>{e.addEventListener("click",()=>{const t=e.getAttribute("data-quick");this.executeCommand(t)})}),this.telemetryHandler=e=>{this.updateParserState(e.detail)},window.addEventListener("telemetry",this.telemetryHandler)}static executeCurrentCommand(){const e=document.getElementById("gcode-input");if(!e)return;const t=e.value,n=e.selectionStart,i=t.split("\n");let o=0,a="";for(let e of i){if(o+e.length>=n){a=e.trim();break}o+=e.length+1}a&&a.length>0?this.executeCommand(a):AlertManager.add("No command on current line","warning",2e3)}static async executeAllCommands(){const e=document.getElementById("gcode-input");if(!e)return;const t=e.value.split("\n").map(e=>e.trim()).filter(e=>e.length>0);if(0!==t.length){this.executing=!0,this.currentLine=0,this.updateExecutionButtons();for(let e=0;e<t.length&&this.executing;e++){for(;this.paused&&this.executing;)await new Promise(e=>setTimeout(e,100));this.currentLine=e+1,await this.executeCommand(t[e],!0),await new Promise(e=>setTimeout(e,50))}this.executing=!1,this.currentLine=0,this.updateExecutionButtons()}else AlertManager.add("No commands to execute","warning",2e3)}static stopExecution(){this.executing=!1,this.paused=!1,this.currentLine=0,this.updateExecutionButtons();const e=document.getElementById("pause-execution");e&&(e.querySelector("span").textContent="â¸ï¸ Pause")}static updateExecutionButtons(){const e=document.getElementById("send-command"),t=document.getElementById("send-all");e&&(e.disabled=this.executing),t&&(t.disabled=this.executing)}static async executeCommand(e,t=!1){if(!e||e.startsWith(";")||e.startsWith("("))return;const n=/^G(0|1|28)/i.test(e);n&&this.showExecutionCard(e);try{const i=await fetch("/api/gcode",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({command:e}),credentials:"same-origin"}),o=await i.json();if(o.success){if(t||AlertManager.add("Command executed successfully","success",2e3),n&&void 0!==o.eta_seconds&&this.updateExecutionCardETA(o.eta_seconds,o.distance_mm,o.speed_mm_min),n){const e=1e3*(o.eta_seconds||3)+2e3;setTimeout(()=>this.hideExecutionCardIfStale(),e)}}else t||AlertManager.add("Command failed","critical",3e3),n&&this.hideExecutionCard()}catch(e){console.error("[GCODE] Execute error:",e),t||AlertManager.add("Communication error","critical",3e3),n&&this.hideExecutionCard()}}static showExecutionCard(e){const t=document.getElementById("execution-card"),n=document.getElementById("execution-cmd"),i=document.getElementById("execution-progress"),o=document.getElementById("execution-eta"),a=document.getElementById("execution-percent");if(t&&n&&i&&(this._lastCardShowTime=Date.now(),t.style.display="block",n.textContent=e,i.style.width="15%",i.style.background="linear-gradient(90deg, var(--primary-color), var(--color-warning))",a&&(a.textContent="0%"),o)){const t=this.estimateETA(e);o.textContent=t>0?t>60?`ETA: ${(t/60).toFixed(1)}m`:`ETA: ${t.toFixed(1)}s`:"Calculating..."}}static estimateETA(e){const t=e.match(/X(-?\d+\.?\d*)/i),n=e.match(/Y(-?\d+\.?\d*)/i),i=e.match(/Z(-?\d+\.?\d*)/i),o=e.match(/F(-?\d+\.?\d*)/i),a=t?parseFloat(t[1]):0,s=n?parseFloat(n[1]):0,c=i?parseFloat(i[1]):0,r=o?parseFloat(o[1]):100,d=Math.sqrt(a*a+s*s+c*c);return r>0&&d>0?d/r*60:0}static hideExecutionCard(){const e=document.getElementById("execution-card");e&&(e.style.display="none")}static updateExecutionCardETA(e,t,n){const i=document.getElementById("execution-eta");document.getElementById("execution-percent");i&&(e>60?i.textContent=`ETA: ${(e/60).toFixed(1)}m | ${t?.toFixed(0)||"?"}mm @ ${n?.toFixed(0)||"?"}mm/min`:e>0&&(i.textContent=`ETA: ${e.toFixed(1)}s | ${t?.toFixed(0)||"?"}mm @ ${n?.toFixed(0)||"?"}mm/min`))}static hideExecutionCardIfStale(){Date.now()-(this._lastCardShowTime||0)>2500&&this.hideExecutionCard()}static updateParserState(e=null){if(e){const t=document.getElementById("motion-state");if(t){const n=e.motion_active?"Moving":"Idle";t.textContent=n,t.style.color=e.motion_active?"var(--color-warning)":"var(--color-optimal)"}if(e.parser){const t=document.getElementById("coord-mode");t&&(t.textContent=e.parser.absolute_mode?"Absolute (G90)":"Relative (G91)");const n=document.getElementById("feed-rate");if(n){const t=e.parser.actual_feedrate,i=e.parser.feedrate||0;t&&Math.abs(t-i)>1?(n.textContent=`${Math.round(t)} mm/min (calibrated)`,n.style.color="var(--color-warning)"):(n.textContent=`${Math.round(i)} mm/min`,n.style.color="")}}const n=document.getElementById("execution-card"),i=document.getElementById("execution-cmd"),o=document.getElementById("execution-progress"),a=document.getElementById("execution-eta");if(n&&i&&o&&e.exec){const t=e.exec.cmd||"",s=e.exec.progress||0,c=e.exec.eta||0;if(t.length>0&&s<100&&e.motion_active){this._lastCardShowTime=Date.now(),n.style.display="block",i.textContent=t,o.style.width=`${Math.max(15,s)}%`;const e=document.getElementById("execution-percent");e&&(e.textContent=`${Math.round(s)}%`),a.textContent=c>60?`ETA: ${(c/60).toFixed(1)}m`:c>0?`ETA: ${c.toFixed(1)}s`:""}else if("none"!==n.style.display){if(Date.now()-(this._lastCardShowTime||0)<3e3)return;s>=99.9?(o.style.width="100%",o.style.backgroundColor="var(--color-optimal)",setTimeout(()=>{n.style.display="none",o.style.backgroundColor="var(--primary-color)"},2e3)):n.style.display="none"}}}e||"file:"===window.location.protocol||fetch("/api/gcode/state").then(e=>e.json()).then(e=>{if(e.success){const t=document.getElementById("coord-mode");t&&(t.textContent=e.absolute_mode?"Absolute (G90)":"Relative (G91)");const n=document.getElementById("feed-rate");n&&(n.textContent=(e.feedrate||0)+" mm/min")}}).catch(e=>{console.warn("[GCODE] Failed to fetch parser state:",e)})}static loadExamples(){const e=document.getElementById("gcode-input");e&&(e.value="; Example G-code Program\n; Basic movement and positioning\n\n; Set to absolute positioning\nG90\n\n; Home all axes\nG28\n\n; Move to starting position\nG0 X0 Y0 Z10 F1000\n\n; Linear move\nG1 X50 Y50 Z5 F500\n\n; Set work coordinate zero\nG92 X0 Y0 Z0 A0\n\n; Display message on LCD\nM117 Program Complete\n\n; Get current position\nM114\n",this.updateLineNumbers())}static cleanup(){console.log("[GCODE] Page cleanup"),this.executing=!1,this.telemetryHandler&&window.removeEventListener("telemetry",this.telemetryHandler);const e=document.getElementById("gcode-input");e&&(this.inputHandler&&e.removeEventListener("input",this.inputHandler),this.scrollHandler&&e.removeEventListener("scroll",this.scrollHandler))}static async fetchQueueState(){try{const e=await fetch("/api/gcode/queue",{credentials:"same-origin"}),t=await e.json();t.success&&this.renderQueueState(t)}catch(e){console.error("[GCODE] Queue fetch error:",e)}}static renderQueueState(e){const t=document.getElementById("queue-summary"),n=document.getElementById("job-list"),i=document.getElementById("recovery-actions");if(t){const n=e.queue;t.textContent=`${n.total} jobs â€¢ ${n.completed} âœ“ â€¢ ${n.failed} âœ— â€¢ ${n.pending} pending`}if(i&&(i.style.display=e.queue.paused?"block":"none"),n&&e.jobs){const t={0:"â³",1:"ðŸ”„",2:"âœ…",3:"âŒ",4:"â­ï¸"},i={0:"var(--text-muted)",1:"var(--color-warning)",2:"var(--color-optimal)",3:"var(--color-critical)",4:"var(--text-muted)"};n.innerHTML=e.jobs.map(e=>`\n                    <div class="job-item" style="display: flex; justify-content: space-between; padding: 6px 8px; border-bottom: 1px solid var(--border-color); font-family: monospace; font-size: 0.85em;">\n                        <span style="color: ${i[e.status]};">\n                            ${t[e.status]} #${e.id}: ${e.command.substring(0,30)}${e.command.length>30?"...":""}\n                        </span>\n                        ${e.error?`<span style="color: var(--color-critical); font-size: 0.8em;">${e.error}</span>`:""}\n                    </div>\n                `).join("")}}static async retryJob(){try{const e=await fetch("/api/gcode/queue/retry",{method:"POST",credentials:"same-origin"}),t=await e.json();t.success?(AlertManager.add("Retrying job from start position...","success",2e3),this.fetchQueueState()):AlertManager.add(t.error||"Retry failed","critical",3e3)}catch(e){AlertManager.add("Communication error","critical",3e3)}}static async resumeJob(){try{const e=await fetch("/api/gcode/queue/resume",{method:"POST",credentials:"same-origin"}),t=await e.json();t.success?(AlertManager.add("Resuming from current position...","success",2e3),this.fetchQueueState()):AlertManager.add(t.error||"Resume failed","critical",3e3)}catch(e){AlertManager.add("Communication error","critical",3e3)}}static async skipJob(){try{const e=await fetch("/api/gcode/queue/skip",{method:"POST",credentials:"same-origin"}),t=await e.json();t.success?(AlertManager.add("Skipping to next job...","success",2e3),this.fetchQueueState()):AlertManager.add(t.error||"Skip failed","critical",3e3)}catch(e){AlertManager.add("Communication error","critical",3e3)}}static async clearQueue(){try{(await fetch("/api/gcode/queue",{method:"DELETE",credentials:"same-origin"})).ok&&(AlertManager.add("Queue history cleared","success",2e3),this.fetchQueueState())}catch(e){AlertManager.add("Communication error","critical",3e3)}}static initQueueUI(){document.getElementById("retry-job")?.addEventListener("click",()=>this.retryJob()),document.getElementById("resume-job")?.addEventListener("click",()=>this.resumeJob()),document.getElementById("skip-job")?.addEventListener("click",()=>this.skipJob()),document.getElementById("refresh-queue")?.addEventListener("click",()=>this.fetchQueueState()),document.getElementById("clear-queue")?.addEventListener("click",()=>this.clearQueue()),this.fetchQueueState(),this._queueInterval=setInterval(()=>this.fetchQueueState(),5e3)}}window.GCodePage=e,window.currentPageModule=e}();