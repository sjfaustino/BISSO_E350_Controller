<!--
  gcode.html - G-code command input, file upload, and execution interface
-->
<div class="gcode-page">
    <!-- G-code Editor Card -->
    <div class="card" style="margin-bottom: var(--space-xl);">
        <div class="card-header">
            <h2>G-CODE COMMAND INPUT</h2>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-sm btn-ghost" id="clear-editor" title="Clear editor">Clear</button>
                <button class="btn btn-sm btn-ghost" id="load-examples" title="Load example G-code">Examples</button>
            </div>
        </div>
        <div class="card-content">
            <div class="gcode-editor-container">
                <div class="line-numbers" id="line-numbers"></div>
                <textarea id="gcode-input" class="gcode-editor"
                    placeholder="Enter G-code commands here...&#10;Example:&#10;G0 X10 Y20 F100&#10;G1 Z5 F50&#10;M117 Hello World"
                    spellcheck="false"></textarea>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                <button class="btn btn-primary" id="send-command">
                    <span>‚ñ∂Ô∏è Execute Command</span>
                </button>
                <button class="btn btn-secondary" id="send-all">
                    <span>‚ñ∂Ô∏è‚ñ∂Ô∏è Execute All Lines</span>
                </button>
                <button class="btn btn-warning" id="pause-execution">
                    <span>‚è∏Ô∏è Pause</span>
                </button>
                <button class="btn btn-danger" id="stop-execution">
                    <span>‚èπÔ∏è Stop</span>
                </button>
            </div>
        </div>
    </div>

    <div class="card-grid" style="grid-template-columns: 1fr 1fr;">
        <!-- Parser State Card -->
        <div class="card">
            <div class="card-header">
                <h2>Parser State</h2>
            </div>
            <div class="card-content">
                <div style="display: grid; grid-template-columns: auto 1fr; gap: 10px 20px; align-items: center;">
                    <span class="metric-label">Distance Mode:</span>
                    <span class="metric-value" id="distance-mode">G90 (Absolute)</span>

                    <span class="metric-label">Work Coordinate:</span>
                    <span class="metric-value" id="work-coordinate">G54</span>

                    <span class="metric-label">Feed Rate:</span>
                    <span class="metric-value" id="feed-rate">-- mm/min</span>

                    <span class="metric-label">Motion State:</span>
                    <span class="metric-value" id="motion-state">Idle</span>
                </div>
            </div>
        </div>

        <!-- Quick Commands Card -->
        <div class="card">
            <div class="card-header">
                <h2>Quick Commands</h2>
            </div>
            <div class="card-content">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                    <button class="btn btn-ghost btn-sm" data-quick="G28">üè† Home All</button>
                    <button class="btn btn-ghost btn-sm" data-quick="M114">üìç Get Position</button>
                    <button class="btn btn-ghost btn-sm" data-quick="M115">‚ÑπÔ∏è Firmware Info</button>
                    <button class="btn btn-ghost btn-sm" data-quick="G90">üìê Absolute Mode</button>
                    <button class="btn btn-ghost btn-sm" data-quick="G91">üìê Relative Mode</button>
                    <button class="btn btn-ghost btn-sm" data-quick="G92 X0 Y0 Z0 A0">üéØ Zero Position</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Current Execution Card (Hidden by default) -->
    <div class="card" id="execution-card" style="display: none; margin-bottom: var(--space-xl);">
        <div class="card-header">
            <h2>CURRENT EXECUTION</h2>
            <div id="execution-eta" style="font-family: monospace; font-size: 0.9em; color: var(--text-muted);"></div>
        </div>
        <div class="card-content">
            <div style="font-family: monospace; font-size: 1.1em; margin-bottom: 10px; color: var(--text-primary);"
                id="execution-cmd"></div>
            <div class="progress-bar-container"
                style="height: 28px; background: var(--bg-secondary); border-radius: 4px; overflow: hidden; position: relative; border: 1px solid var(--border-color);">
                <div id="execution-progress"
                    style="width: 0%; height: 100%; background: linear-gradient(90deg, var(--primary-color), var(--color-optimal)); transition: width 0.5s ease-out; min-width: 30px;">
                </div>
                <span id="execution-percent"
                    style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); font-family: monospace; font-weight: bold; color: var(--text-primary);">0%</span>
            </div>
        </div>
    </div>

    <!-- Job Queue Status Card (Server-Side History) -->
    <div class="card" id="queue-status-card">
        <div class="card-header">
            <h2>JOB QUEUE STATUS</h2>
            <div style="display: flex; gap: 8px; align-items: center;">
                <span id="queue-summary" style="font-size: 0.85em; color: var(--text-muted);">0 jobs</span>
                <button class="btn btn-sm btn-ghost" id="refresh-queue" title="Refresh">üîÑ</button>
                <button class="btn btn-sm btn-danger" id="clear-queue" title="Clear History">üóëÔ∏è</button>
            </div>
        </div>
        <div class="card-content">
            <!-- Recovery Actions (shown when paused on error) -->
            <div id="recovery-actions"
                style="display: none; background: var(--color-critical-bg); padding: 12px; border-radius: 4px; margin-bottom: 12px;">
                <div style="color: var(--color-critical); font-weight: bold; margin-bottom: 8px;">‚ö†Ô∏è Queue Paused - Job
                    Failed</div>
                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                    <button class="btn btn-sm btn-warning" id="retry-job" title="Move to start position and retry">üîÅ
                        Retry from Start</button>
                    <button class="btn btn-sm btn-primary" id="resume-job" title="Continue from current position">‚ñ∂Ô∏è
                        Resume</button>
                    <button class="btn btn-sm btn-ghost" id="skip-job" title="Skip to next command">‚è≠Ô∏è Skip</button>
                </div>
            </div>
            <!-- Job List -->
            <div id="job-list" class="job-list" style="max-height: 200px; overflow-y: auto;"></div>
        </div>
    </div>

    <!-- Execution Log Card (Client-Side) -->
    <div class="card">
        <div class="card-header">
            <h2>QUEUE LOG</h2>
            <button class="btn btn-sm btn-ghost" id="clear-log">Clear Log</button>
        </div>
        <div class="card-content">
            <div id="execution-log" class="execution-log"></div>
        </div>
    </div>
</div>

<style>
    .gcode-editor-container {
        display: flex;
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        background: var(--bg-secondary);
        overflow: hidden;
    }

    .line-numbers {
        background: var(--bg-tertiary);
        color: var(--text-muted);
        padding: 10px 8px;
        text-align: right;
        font-family: 'Courier New', monospace;
        font-size: 14px;
        line-height: 1.5;
        user-select: none;
        border-right: 1px solid var(--border-color);
        min-width: 40px;
        white-space: pre;
    }

    .gcode-editor {
        flex: 1;
        min-height: 200px;
        padding: 10px;
        border: none;
        background: transparent;
        color: var(--text-primary);
        font-family: 'Courier New', monospace;
        font-size: 14px;
        line-height: 1.5;
        resize: vertical;
        outline: none;
    }

    .gcode-editor:focus {
        background: var(--bg-primary);
    }

    .execution-log {
        font-family: 'Courier New', monospace;
        font-size: 13px;
        max-height: 300px;
        overflow-y: auto;
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        padding: 10px;
    }

    .log-entry {
        padding: 4px 0;
        border-bottom: 1px solid var(--border-color);
    }

    .log-entry:last-child {
        border-bottom: none;
    }

    .log-entry.success {
        color: var(--color-optimal);
    }

    .log-entry.error {
        color: var(--color-critical);
    }

    .log-entry.info {
        color: var(--text-muted);
    }

    .log-timestamp {
        color: var(--text-muted);
        font-size: 11px;
        margin-right: 8px;
    }

    .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
</style>