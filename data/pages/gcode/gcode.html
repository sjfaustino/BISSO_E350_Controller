<!--
  gcode.html - G-code command input, file upload, and execution interface
-->
<div class="gcode-page" id="gcode-page-root">
    <!-- G-code Editor Card -->
    <div class="card" style="margin-bottom: var(--space-xl);">
        <div class="card-header">
            <h2 data-i18n="gcode.command_input">G-CODE COMMAND INPUT</h2>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-sm btn-ghost" id="clear-editor" title="Clear editor"
                    data-i18n="gcode.clear">Clear</button>
                <button class="btn btn-sm btn-ghost" id="load-examples" title="Load example G-code"
                    data-i18n="gcode.examples">Examples</button>
            </div>
        </div>
        <div class="card-content">
            <div class="gcode-editor-container">
                <div class="line-numbers" id="line-numbers"></div>
                <textarea id="gcode-input" class="gcode-editor"
                    placeholder="Enter G-code commands here...&#10;Example:&#10;G0 X10 Y20 F100&#10;G1 Z5 F50&#10;M117 Hello World"
                    spellcheck="false"></textarea>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                <button class="btn btn-primary" id="send-command">
                    <span data-i18n="gcode.execute_cmd">‚ñ∂Ô∏è Execute Command</span>
                </button>
                <button class="btn btn-secondary" id="send-all">
                    <span data-i18n="gcode.execute_all">‚ñ∂Ô∏è‚ñ∂Ô∏è Execute All Lines</span>
                </button>
                <button class="btn btn-warning" id="pause-execution">
                    <span data-i18n="gcode.pause">‚è∏Ô∏è Pause</span>
                </button>
                <button class="btn btn-danger" id="stop-execution">
                    <span data-i18n="gcode.stop">‚èπÔ∏è Stop</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Path Visualizer Card -->
    <div class="card" id="visualizer-card"
        style="margin-bottom: var(--space-xl); border: 2px solid orange !important; min-height: 100px;">
        <div class="card-header">
            <h2 data-i18n="gcode.preview">PATH PREVIEW</h2>
            <div style="display: flex; gap: 8px;">
                <button class="btn btn-sm btn-ghost" id="viz-zoom-in" title="Zoom In">
                    <span data-i18n="gcode.zoom_in">‚ûï</span>
                </button>
                <button class="btn btn-sm btn-ghost" id="viz-zoom-out" title="Zoom Out">
                    <span data-i18n="gcode.zoom_out">‚ûñ</span>
                </button>
                <button class="btn btn-sm btn-ghost" id="viz-reset" title="Reset View">
                    <span data-i18n="gcode.reset_view">üîÑ</span>
                </button>
            </div>
        </div>
        <div class="card-content" style="background: rgba(0,0,0,0.1);">
            <div class="visualizer-container" style="background: #000; min-height: 300px;">
                <canvas id="gcode-preview"
                    style="display: block; width: 100%; height: 300px; background: #111;"></canvas>
            </div>
        </div>
    </div>

    <div class="card-grid" style="grid-template-columns: 1fr 1fr;">
        <!-- Parser State Card -->
        <div class="card">
            <div class="card-header">
                <h2 data-i18n="gcode.parser_state">Parser State</h2>
            </div>
            <div class="card-content">
                <div style="display: grid; grid-template-columns: auto 1fr; gap: 10px 20px; align-items: center;">
                    <span class="metric-label" data-i18n="gcode.distance_mode">Distance Mode:</span>
                    <span class="metric-value" id="distance-mode">G90 (Absolute)</span>

                    <span class="metric-label" data-i18n="gcode.work_coord">Work Coordinate:</span>
                    <span class="metric-value" id="work-coordinate">G54</span>

                    <span class="metric-label" data-i18n="gcode.feed_rate">Feed Rate:</span>
                    <span class="metric-value" id="feed-rate">-- mm/min</span>

                    <span class="metric-label" data-i18n="gcode.motion_state">Motion State:</span>
                    <span class="metric-value" id="motion-state">Idle</span>
                </div>
            </div>
        </div>

        <!-- Quick Commands Card -->
        <div class="card">
            <div class="card-header">
                <h2 data-i18n="gcode.quick_commands">Quick Commands</h2>
            </div>
            <div class="card-content">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                    <button class="btn btn-ghost btn-sm" data-quick="G28" data-i18n="gcode.home_all">üè† Home
                        All</button>
                    <button class="btn btn-ghost btn-sm" data-quick="M114" data-i18n="gcode.get_position">üìç Get
                        Position</button>
                    <button class="btn btn-ghost btn-sm" data-quick="M115" data-i18n="gcode.firmware_info">‚ÑπÔ∏è Firmware
                        Info</button>
                    <button class="btn btn-ghost btn-sm" data-quick="G90" data-i18n="gcode.absolute_mode">üìê Absolute
                        Mode</button>
                    <button class="btn btn-ghost btn-sm" data-quick="G91" data-i18n="gcode.relative_mode">üìê Relative
                        Mode</button>
                    <button class="btn btn-ghost btn-sm" data-quick="G92 X0 Y0 Z0 A0" data-i18n="gcode.zero_position">üéØ
                        Zero Position</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Current Execution Card (Hidden by default) -->
    <div class="card" id="execution-card" style="display: none; margin-bottom: var(--space-xl);">
        <div class="card-header">
            <h2 data-i18n="gcode.current_execution">CURRENT EXECUTION</h2>
            <div id="execution-eta" style="font-family: monospace; font-size: 0.9em; color: var(--text-muted);"></div>
        </div>
        <div class="card-content">
            <div style="font-family: monospace; font-size: 1.1em; margin-bottom: 10px; color: var(--text-primary);"
                id="execution-cmd"></div>
            <div class="progress-bar-container"
                style="height: 28px; background: var(--bg-secondary); border-radius: 4px; overflow: hidden; position: relative; border: 1px solid var(--border-color);">
                <div id="execution-progress"
                    style="width: 0%; height: 100%; background: linear-gradient(90deg, var(--primary-color), var(--color-optimal)); transition: width 0.5s ease-out; min-width: 30px;">
                </div>
                <span id="execution-percent"
                    style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); font-family: monospace; font-weight: bold; color: var(--text-primary);">0%</span>
            </div>
        </div>
    </div>

    <!-- Job Queue Status Card (Server-Side History) -->
    <div class="card" id="queue-status-card">
        <div class="card-header">
            <h2 data-i18n="gcode.job_queue">JOB QUEUE STATUS</h2>
            <div style="display: flex; gap: 8px; align-items: center;">
                <span id="queue-summary" style="font-size: 0.85em; color: var(--text-muted);">0 jobs</span>
                <button class="btn btn-sm btn-ghost" id="refresh-queue" title="Refresh">üîÑ</button>
                <button class="btn btn-sm btn-danger" id="clear-queue" title="Clear History">üóëÔ∏è</button>
            </div>
        </div>
        <div class="card-content">
            <!-- Recovery Actions (shown when paused on error) -->
            <div id="recovery-actions"
                style="display: none; background: var(--color-critical-bg); padding: 12px; border-radius: 4px; margin-bottom: 12px;">
                <div style="color: var(--color-critical); font-weight: bold; margin-bottom: 8px;">‚ö†Ô∏è Queue Paused - Job
                    Failed</div>
                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                    <button class="btn btn-sm btn-warning" id="retry-job" title="Move to start position and retry">üîÅ
                        Retry from Start</button>
                    <button class="btn btn-sm btn-primary" id="resume-job" title="Continue from current position">‚ñ∂Ô∏è
                        Resume</button>
                    <button class="btn btn-sm btn-ghost" id="skip-job" title="Skip to next command">‚è≠Ô∏è Skip</button>
                </div>
            </div>
            <!-- Job List -->
            <div id="job-list" class="job-list" style="max-height: 200px; overflow-y: auto;"></div>
        </div>
    </div>


</div>

<style>
    .gcode-editor-container {
        display: flex;
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        background: var(--bg-secondary);
        overflow: hidden;
    }

    .line-numbers {
        background: var(--bg-tertiary);
        color: var(--text-muted);
        padding: 10px 8px;
        text-align: right;
        font-family: 'Courier New', monospace;
        font-size: 14px;
        line-height: 1.5;
        user-select: none;
        border-right: 1px solid var(--border-color);
        min-width: 40px;
        white-space: pre;
    }

    .gcode-editor {
        flex: 1;
        min-height: 200px;
        padding: 10px;
        border: none;
        background: transparent;
        color: var(--text-primary);
        font-family: 'Courier New', monospace;
        font-size: 14px;
        line-height: 1.5;
        resize: vertical;
        outline: none;
    }

    .gcode-editor:focus {
        background: var(--bg-primary);
    }



    .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
</style>