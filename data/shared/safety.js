class SafetyManager{static alarmBanner=null;static estopButton=null;static alarmCheckInterval=null;static currentAlarms=[];static estopActive=!1;static init(){this.createAlarmBanner(),this.createEstopButton(),this.startAlarmMonitoring(),console.log("[SAFETY] Manager initialized")}static createAlarmBanner(){const n=document.createElement("div");n.id="alarm-banner",n.className="alarm-banner",n.style.display="none",n.innerHTML='\n            <div class="alarm-content">\n                <div class="alarm-icon">⚠️</div>\n                <div class="alarm-details">\n                    <div class="alarm-title">SYSTEM ALARM</div>\n                    <div class="alarm-message" id="alarm-message"></div>\n                </div>\n                <button class="alarm-dismiss" id="alarm-dismiss" title="Dismiss">✕</button>\n            </div>\n        ',document.body.appendChild(n),this.alarmBanner=n,document.getElementById("alarm-dismiss")?.addEventListener("click",()=>{this.dismissAlarm()})}static createEstopButton(){const n=document.createElement("div");n.id="estop-button",n.className="estop-button",n.innerHTML='\n            <button class="estop-btn" id="estop-trigger" title="Emergency Stop">\n                <div class="estop-icon">⏹</div>\n                <div class="estop-label">E-STOP</div>\n            </button>\n        ',document.body.appendChild(n),this.estopButton=n,document.getElementById("estop-trigger")?.addEventListener("click",()=>{this.confirmEstop()})}static startAlarmMonitoring(){this.alarmCheckInterval=setInterval(()=>{this.checkAlarms()},2e3),this.checkAlarms()}static async checkAlarms(){try{if("file:"===window.location.protocol)return this.estopActive=!1,this.updateEstopButton(),void this.hideAlarm();const n=await fetch("/api/alarms",{credentials:"same-origin"});if(!n.ok)return;const t=await n.json();if(this.estopActive=t.estop_active,this.updateEstopButton(),t.estop_active)this.showAlarm("EMERGENCY STOP ACTIVE","critical");else if(t.faults&&t.faults.length>0){const n=t.faults.find(n=>"CRITICAL"===n.severity||"ERROR"===n.severity);n&&this.showAlarm(`${n.code}: ${n.message}`,"CRITICAL"===n.severity?"critical":"warning")}else this.hideAlarm();this.currentAlarms=t.faults||[]}catch(n){console.error("[SAFETY] Alarm check error:",n)}}static showAlarm(n,t="warning"){if(!this.alarmBanner)return;const e=document.getElementById("alarm-message");e&&(e.textContent=n),this.alarmBanner.className=`alarm-banner alarm-${t}`,this.alarmBanner.style.display="block","critical"===t?this.alarmBanner.classList.add("alarm-flash"):this.alarmBanner.classList.remove("alarm-flash")}static hideAlarm(){this.alarmBanner&&(this.alarmBanner.style.display="none")}static dismissAlarm(){this.estopActive?AlertManager.add("Cannot dismiss - E-stop active! Reset E-stop first.","critical",3e3):this.hideAlarm()}static updateEstopButton(){const n=document.getElementById("estop-trigger");n&&(this.estopActive?(n.classList.add("estop-active"),n.querySelector(".estop-label").textContent="RESET",n.title="Reset Emergency Stop"):(n.classList.remove("estop-active"),n.querySelector(".estop-label").textContent="E-STOP",n.title="Emergency Stop"))}static confirmEstop(){this.estopActive?confirm("Reset Emergency Stop?\n\nEnsure it is safe to resume operation.")&&this.resetEstop():confirm("Trigger Emergency Stop?\n\nThis will halt all motion immediately.")&&this.triggerEstop()}static async triggerEstop(){if("file:"!==window.location.protocol)try{(await fetch("/api/estop/trigger",{method:"POST",credentials:"same-origin"})).ok?(AlertManager.add("Emergency Stop Activated","critical",5e3),this.checkAlarms()):AlertManager.add("Failed to trigger E-stop","critical",3e3)}catch(n){console.error("[SAFETY] E-stop trigger error:",n),AlertManager.add("Communication error","critical",3e3)}else AlertManager.add("E-stop not available in offline mode","warning",3e3)}static async resetEstop(){if("file:"!==window.location.protocol)try{const n=await fetch("/api/estop/reset",{method:"POST",credentials:"same-origin"});(await n.json()).success?(AlertManager.add("Emergency Stop Reset - Operation can resume","success",3e3),this.checkAlarms()):AlertManager.add("E-stop reset failed - Check system state","critical",3e3)}catch(n){console.error("[SAFETY] E-stop reset error:",n),AlertManager.add("Communication error","critical",3e3)}else AlertManager.add("E-stop reset not available in offline mode","warning",3e3)}static cleanup(){this.alarmCheckInterval&&clearInterval(this.alarmCheckInterval)}}const safetyStyles="\n<style>\n.alarm-banner {\n    position: fixed;\n    top: 60px;\n    left: 0;\n    right: 0;\n    z-index: 9999;\n    padding: 15px 20px;\n    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);\n    animation: slideDown 0.3s ease;\n}\n\n.alarm-banner.alarm-critical {\n    background: var(--color-critical);\n    color: white;\n}\n\n.alarm-banner.alarm-warning {\n    background: var(--color-warning);\n    color: white;\n}\n\n.alarm-content {\n    display: flex;\n    align-items: center;\n    gap: 15px;\n    max-width: 1200px;\n    margin: 0 auto;\n}\n\n.alarm-icon {\n    font-size: 32px;\n    flex-shrink: 0;\n}\n\n.alarm-details {\n    flex: 1;\n}\n\n.alarm-title {\n    font-weight: bold;\n    font-size: 16px;\n    margin-bottom: 4px;\n    letter-spacing: 1px;\n}\n\n.alarm-message {\n    font-size: 14px;\n    opacity: 0.95;\n}\n\n.alarm-dismiss {\n    background: rgba(255, 255, 255, 0.2);\n    border: none;\n    color: white;\n    width: 30px;\n    height: 30px;\n    border-radius: 50%;\n    cursor: pointer;\n    font-size: 20px;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    flex-shrink: 0;\n}\n\n.alarm-dismiss:hover {\n    background: rgba(255, 255, 255, 0.3);\n}\n\n.alarm-flash {\n    animation: flash 1s infinite;\n}\n\n@keyframes flash {\n    0%, 100% { opacity: 1; }\n    50% { opacity: 0.7; }\n}\n\n@keyframes slideDown {\n    from {\n        transform: translateY(-100%);\n        opacity: 0;\n    }\n    to {\n        transform: translateY(0);\n        opacity: 1;\n    }\n}\n\n.estop-button {\n    position: fixed;\n    bottom: 30px;\n    right: 30px;\n    z-index: 9998;\n}\n\n.estop-btn {\n    background: var(--color-critical);\n    color: white;\n    border: 3px solid #fff;\n    border-radius: 50%;\n    width: 90px;\n    height: 90px;\n    cursor: pointer;\n    display: flex;\n    flex-direction: column;\n    align-items: center;\n    justify-content: center;\n    box-shadow: 0 4px 16px rgba(220, 38, 38, 0.5);\n    transition: all 0.2s ease;\n}\n\n.estop-btn:hover {\n    transform: scale(1.05);\n    box-shadow: 0 6px 20px rgba(220, 38, 38, 0.7);\n}\n\n.estop-btn:active {\n    transform: scale(0.95);\n}\n\n.estop-btn.estop-active {\n    background: var(--color-warning);\n    animation: pulse 1.5s infinite;\n}\n\n.estop-icon {\n    font-size: 32px;\n    line-height: 1;\n}\n\n.estop-label {\n    font-size: 11px;\n    font-weight: bold;\n    margin-top: 4px;\n    letter-spacing: 0.5px;\n}\n\n@keyframes pulse {\n    0%, 100% { opacity: 1; }\n    50% { opacity: 0.6; }\n}\n\n@media (max-width: 768px) {\n    .alarm-banner {\n        top: 50px;\n        padding: 12px 15px;\n    }\n\n    .alarm-icon {\n        font-size: 24px;\n    }\n\n    .alarm-title {\n        font-size: 14px;\n    }\n\n    .alarm-message {\n        font-size: 12px;\n    }\n\n    .estop-button {\n        bottom: 20px;\n        right: 20px;\n    }\n\n    .estop-btn {\n        width: 70px;\n        height: 70px;\n    }\n\n    .estop-icon {\n        font-size: 24px;\n    }\n\n    .estop-label {\n        font-size: 9px;\n    }\n}\n</style>\n";document.head.insertAdjacentHTML("beforeend",safetyStyles),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>SafetyManager.init()):SafetyManager.init(),window.SafetyManager=SafetyManager;