class GraphVisualizer{constructor(t,i={}){if(this.canvas=document.getElementById(t),this.series=new Map,this.seriesColors=["#10b981","#3b82f6","#f59e0b","#ef4444","#8b5cf6","#ec4899"],this.config={title:i.title||"Graph",timeWindow:i.timeWindow||3e5,maxPoints:i.maxPoints||300,updateInterval:i.updateInterval||1e3,yMin:i.yMin||0,yMax:i.yMax||100,autoScale:!1!==i.autoScale,unit:i.unit||"%",showGrid:!1!==i.showGrid,showLegend:!1!==i.showLegend,...i},!this.canvas)return console.error(`[Graph] Canvas element '${t}' not found`),void(this.isDisabled=!0);this.ctx=this.canvas.getContext("2d"),this.width=this.canvas.width,this.height=this.canvas.height,this.colors={bg:getComputedStyle(document.documentElement).getPropertyValue("--bg-primary")||"#ffffff",grid:getComputedStyle(document.documentElement).getPropertyValue("--border-color")||"#e5e7eb",text:getComputedStyle(document.documentElement).getPropertyValue("--text-primary")||"#000000",optimal:getComputedStyle(document.documentElement).getPropertyValue("--color-optimal")||"#10b981",normal:getComputedStyle(document.documentElement).getPropertyValue("--color-normal")||"#3b82f6",warning:getComputedStyle(document.documentElement).getPropertyValue("--color-warning")||"#f59e0b",critical:getComputedStyle(document.documentElement).getPropertyValue("--color-critical")||"#ef4444"},this.seriesColors=[this.colors.optimal,this.colors.normal,this.colors.warning,this.colors.critical,"#8b5cf6","#ec4899"],this.resizeObserver=new ResizeObserver(()=>this.handleResize()),this.resizeObserver.observe(this.canvas),this.animationFrame=null,this.lastDrawTime=0,this.draw()}handleResize(){const t=this.canvas.parentElement.getBoundingClientRect();this.canvas.width=t.width,this.canvas.height=t.height,this.width=this.canvas.width,this.height=this.canvas.height,this.draw()}addSeries(t,i=null){if(!this.series.has(t)){const e=this.series.size%this.seriesColors.length;this.series.set(t,{data:[],color:i||this.seriesColors[e],visible:!0})}}addDataPoint(t,i,e=null){this.series.has(t)||this.addSeries(t);const s=this.series.get(t),h=e||Date.now();s.data.push({time:h,value:i});const a=h-this.config.timeWindow;s.data=s.data.filter(t=>t.time>=a),s.data.length>this.config.maxPoints&&(s.data=s.data.slice(-this.config.maxPoints)),this.draw()}toggleSeries(t,i=null){if(this.series.has(t)){const e=this.series.get(t);e.visible=null!==i?i:!e.visible,this.draw()}}clear(){this.series.forEach(t=>{t.data=[]}),this.draw()}clearSeries(t){this.series.has(t)&&(this.series.get(t).data=[],this.draw())}getMinMax(){let t=1/0,i=-1/0;this.series.forEach(e=>{e.visible&&e.data.forEach(e=>{t=Math.min(t,e.value),i=Math.max(i,e.value)})}),t=Math.min(t,this.config.yMin),i=Math.max(i,this.config.yMax),t===1/0&&(t=0),i===-1/0&&(i=100);const e=.1*(i-t);return{min:Math.max(0,t-e),max:i+e}}valueToCanvasY(t,i,e){const s=this.height-60-60;return 60+s-(t-i)/(e-i)*s}timeToCanvasX(t,i,e){return 50+(t-i)/(e-i)*(this.width-50-20)}draw(){if(this.isDisabled||!this.canvas||!this.ctx)return;this.ctx.fillStyle=this.colors.bg,this.ctx.fillRect(0,0,this.width,this.height);let t=Date.now()-this.config.timeWindow,i=Date.now();this.drawTitle(),this.config.showGrid&&this.drawGrid(t,i);const{min:e,max:s}=this.getMinMax();this.drawYAxisLabels(e,s),this.drawXAxisLabels(t,i),this.drawAxes(),this.drawDataSeries(t,i,e,s),this.config.showLegend&&this.drawLegend(e,s)}drawTitle(){this.ctx.fillStyle=this.colors.text,this.ctx.font="bold 14px Arial",this.ctx.textAlign="left",this.ctx.fillText(this.config.title,10,20)}drawGrid(t,i){this.ctx.strokeStyle=this.colors.grid,this.ctx.lineWidth=1,this.ctx.globalAlpha=.3;let e=6e4;this.config.timeWindow>3e5&&(e=18e4),this.config.timeWindow>9e5&&(e=3e5),this.config.timeWindow>18e5&&(e=6e5);for(let s=0;s<this.config.timeWindow;s+=e){const e=i-s,h=this.timeToCanvasX(e,t,i);this.ctx.beginPath(),this.ctx.moveTo(h,50),this.ctx.lineTo(h,this.height-60),this.ctx.stroke()}const{min:s,max:h}=this.getMinMax(),a=this.getGridStep(s,h);for(let t=Math.ceil(s/a)*a;t<=h;t+=a){const i=this.valueToCanvasY(t,s,h);this.ctx.beginPath(),this.ctx.moveTo(50,i),this.ctx.lineTo(this.width-20,i),this.ctx.stroke()}this.ctx.globalAlpha=1}getGridStep(t,i){const e=i-t;if(0===e)return 1;const s=e/6,h=Math.pow(10,Math.floor(Math.log10(s))),a=s/h;let o;return o=a<1.5?1*h:a<3.5?2*h:a<7.5?5*h:10*h,o}drawYAxisLabels(t,i){this.ctx.fillStyle=this.colors.text,this.ctx.font="11px Arial",this.ctx.textAlign="right",this.ctx.globalAlpha=.7;const e=this.getGridStep(t,i);for(let s=Math.ceil(t/e)*e;s<=i;s+=e){const e=this.valueToCanvasY(s,t,i);this.ctx.fillText(s.toFixed(0)+this.config.unit,45,e+4)}this.ctx.globalAlpha=1}drawXAxisLabels(t,i){this.ctx.fillStyle=this.colors.text,this.ctx.font="11px Arial",this.ctx.textAlign="center",this.ctx.globalAlpha=.7;let e=6e4;this.config.timeWindow>3e5&&(e=18e4),this.config.timeWindow>9e5&&(e=3e5),this.config.timeWindow>18e5&&(e=6e5);for(let s=0;s<=this.config.timeWindow;s+=e){const e=i-s,h=this.timeToCanvasX(e,t,i),a=Math.round(s/1e3);let o="";o=0===a?"Now":a<60?a+"s ago":a<3600?Math.round(a/60)+"m ago":Math.round(a/3600)+"h ago",this.ctx.fillText(o,h,this.height-42)}this.ctx.globalAlpha=1}drawAxes(){this.ctx.strokeStyle=this.colors.text,this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.moveTo(50,50),this.ctx.lineTo(50,this.height-60),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(50,this.height-60),this.ctx.lineTo(this.width-20,this.height-60),this.ctx.stroke()}drawDataSeries(t,i,e,s){const{min:h,max:a}=this.getMinMax();this.series.forEach((e,s)=>{if(e.visible&&0!==e.data.length){this.ctx.strokeStyle=e.color,this.ctx.lineWidth=2,this.ctx.globalAlpha=.8,this.ctx.beginPath();for(let s=0;s<e.data.length;s++){const o=e.data[s],n=this.timeToCanvasX(o.time,t,i),l=this.valueToCanvasY(o.value,h,a);0===s?this.ctx.moveTo(n,l):this.ctx.lineTo(n,l)}this.ctx.stroke(),this.ctx.fillStyle=e.color,e.data.forEach(e=>{const s=this.timeToCanvasX(e.time,t,i),o=this.valueToCanvasY(e.value,h,a);this.ctx.fillRect(s-2,o-2,4,4)}),this.ctx.globalAlpha=1}})}drawLegend(t,i){const e=this.height-30;let s=0;this.series.forEach((t,i)=>{if(!t.visible)return;const h=60+120*s,a=e;this.ctx.fillStyle=t.color,this.ctx.globalAlpha=.8,this.ctx.fillRect(h,a,10,10),this.ctx.fillStyle=this.colors.text,this.ctx.globalAlpha=1,this.ctx.font="11px Arial",this.ctx.textAlign="left",this.ctx.fillText(i,h+15,a+9),s++})}destroy(){this.resizeObserver&&this.resizeObserver.disconnect(),this.animationFrame&&cancelAnimationFrame(this.animationFrame)}getStats(t){if(!this.series.has(t))return null;const i=this.series.get(t).data;if(0===i.length)return null;const e=i.map(t=>t.value);return{avg:e.reduce((t,i)=>t+i,0)/e.length,min:Math.min(...e),max:Math.max(...e),current:i[i.length-1].value,count:e.length}}exportData(){let t="Time,"+Array.from(this.series.keys()).join(",")+"\n";if(0===this.series.size)return t;const i=new Map;this.series.forEach((t,e)=>{t.data.forEach(t=>{i.has(t.time)||i.set(t.time,{}),i.get(t.time)[e]=t.value})});const e=Array.from(i.keys()).sort((t,i)=>t-i),s=Array.from(this.series.keys());return e.forEach(e=>{const h=[new Date(e).toISOString()],a=i.get(e);s.forEach(t=>{h.push(a[t]||"")}),t+=h.join(",")+"\n"}),t}}