console.log("[ROUTER] router.js loading...");class Router{static routes={dashboard:{file:"pages/dashboard/dashboard.html",js:"pages/dashboard/dashboard.js"},gcode:{file:"pages/gcode/gcode.html",js:"pages/gcode/gcode.js"},"cut-planner":{file:"pages/cut-planner/cut-planner.html",js:"pages/cut-planner/cut-planner.js"},motion:{file:"pages/motion/motion.html",js:"pages/motion/motion.js"},diagnostics:{file:"pages/diagnostics/diagnostics.html",js:"pages/diagnostics/diagnostics.js"},network:{file:"pages/network/network.html",js:"pages/network/network.js"},system:{file:"pages/system/system.html",js:"pages/system/system.js"},maintenance:{file:"pages/maintenance/maintenance.html",js:"pages/maintenance/maintenance.js"},logs:{file:"pages/logs/logs.html",js:"pages/logs/logs.js"},hardware:{file:"pages/hardware/hardware.html",js:"pages/hardware/hardware.js"},settings:{file:"pages/settings/settings.html",js:"pages/settings/settings.js"},homing:{file:"pages/homing/homing.html",js:"pages/homing/homing.js"}};static currentPage=null;static currentModule=null;static isLoading=!1;static init(){console.log("[ROUTER] Initializing router"),window.addEventListener("hashchange",()=>this.navigate()),this.navigate(),setTimeout(()=>this.checkForUpdates(),2e3)}static async checkForUpdates(){if(document.getElementById("ota-update-banner"))try{const e=await fetch("/api/ota/check"),t=await e.json();if(!t.check_complete)return console.log("[OTA] Background check not complete, retrying..."),void setTimeout(()=>this.checkForUpdates(),3e3);t.available?this.showUpdateBanner(t):console.log("[OTA] Firmware is up to date")}catch(e){console.warn("[OTA] Failed to check for updates:",e)}}static showUpdateBanner(e){const t=document.getElementById("ota-update-banner");t&&(t.innerHTML=`\n            <div class="ota-content">\n                <span class="ota-icon">ðŸš€</span>\n                <div class="ota-text">\n                    New version <strong>${e.latest_version}</strong> is available!\n                </div>\n            </div>\n            <div class="ota-actions">\n                <button class="ota-btn ota-btn-update" id="ota-install-btn">Install Now</button>\n                <button class="ota-btn ota-btn-dismiss" id="ota-dismiss-btn">Later</button>\n            </div>\n        `,t.classList.remove("hidden"),document.getElementById("ota-dismiss-btn").onclick=()=>{t.classList.add("hidden")},document.getElementById("ota-install-btn").onclick=()=>{this.startUpdate(e.url)})}static async startUpdate(e){const t=document.getElementById("ota-update-banner");if(t&&confirm("The device will reboot after updating. Proceed?"))try{const a=await fetch("/api/ota/update",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:e})}),n=await a.json();n.success?(t.innerHTML='\n                    <div class="ota-content">\n                        <span class="ota-icon">ðŸ“¥</span>\n                        <div class="ota-text">Downloading update... do not power off</div>\n                        <div class="ota-progress-container">\n                            <div class="ota-progress-bar" id="ota-progress" style="width: 10%"></div>\n                        </div>\n                    </div>\n                ',this.pollUpdateStatus()):window.Toast?.error(n.error||"Update failed to start")}catch(e){window.Toast?.error("Communication error during update")}}static async pollUpdateStatus(){const e=document.getElementById("ota-progress"),t=setInterval(async()=>{try{const a=await fetch("/api/ota/status"),n=await a.json();n.updating?e&&(e.style.width=`${Math.max(10,n.progress)}%`):clearInterval(t)}catch(e){clearInterval(t),document.getElementById("ota-update-banner").innerHTML='\n                    <div class="ota-content">\n                        <span class="ota-icon">ðŸ”„</span>\n                        <div class="ota-text">Update complete! Reconnecting...</div>\n                    </div>\n                ',setTimeout(()=>window.location.reload(),5e3)}},1e3)}static async navigate(e=null){if(console.log("[ROUTER] Navigate called, page:",e,"isLoading:",this.isLoading),e=e||window.location.hash.slice(1)||"dashboard",!this.routes[e])return console.warn(`[ROUTER] Unknown page: ${e}`),void(window.location.hash="#dashboard");if(this.isLoading)console.log("[ROUTER] Already loading, skipping duplicate navigate request");else{this.isLoading=!0;try{this.currentModule&&this.currentModule.cleanup&&this.currentModule.cleanup();const t=this.routes[e],a=document.getElementById("page-container"),n="file:"===window.location.protocol;let o,s=!1;if(n)s=!0,console.log(`[ROUTER] ${n?"File protocol detected":"offline mode enabled"} - using fallback HTML for:`,e),o=window.FallbackPages?.getPageHTML(e,n)||`<div style="padding: 40px 20px; text-align: center;"><h2>${e} (Fallback)</h2></div>`;else try{const e=await fetch(t.file);if(!e.ok)throw new Error(`HTTP ${e.status}`);o=await e.text()}catch(e){if(s=!0,console.warn(`[ROUTER] Failed to fetch ${t.file}:`,e.message),navigator.onLine)throw e;return o=window.FallbackPages?.getOfflineHTML()||'<div style="padding: 40px 20px; text-align: center;"><h2>Offline</h2></div>',a.innerHTML=o,void(this.isLoading=!1)}if(console.log("[ROUTER] Setting page content, HTML length:",o?.length||0),a.innerHTML=o,console.log("[ROUTER] Page content set successfully"),!s){const e=t.file.replace(".html",".css");this.loadCSS(e).catch(()=>{})}const i=document.createElement("script");i.src=t.js,i.onload=()=>{this.currentPage=e,this.currentModule=window.currentPageModule||{},this.currentModule.init&&this.currentModule.init(),this.updateNav(e),this.isLoading=!1},i.onerror=()=>{console.error(`[ROUTER] Failed to load ${t.js}`),s&&!navigator.onLine&&(a.innerHTML=window.FallbackPages?.getErrorHTML("Could not load page module")||'<div style="color: red;">Error loading page</div>'),this.isLoading=!1},document.body.appendChild(i)}catch(e){console.error("[ROUTER] Navigation error:",e);document.getElementById("page-container").innerHTML=window.FallbackPages?.getErrorHTML(e.message)||`<div style="color: red;">Error: ${e.message}</div>`,this.isLoading=!1}}}static loadCSS(e){return new Promise((t,a)=>{if(document.querySelector(`link[href="${e}"]`))return void t();const n=document.createElement("link");n.rel="stylesheet",n.href=e,n.onload=t,n.onerror=a,document.head.appendChild(n)})}static updateNav(e){document.querySelectorAll(".nav-item").forEach(t=>{const a=t.getAttribute("href").slice(1);t.classList.toggle("active",a===e)})}static go(e){window.location.hash="#"+e}}window.Router=Router,console.log("[ROUTER] Router class defined, typeof Router:",typeof Router),console.log("[ROUTER] Router attached to window, typeof window.Router:",typeof window.Router);