<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="BISSO E350 CNC Control System Dashboard">
    <meta name="theme-color" content="#3b82f6">
    <title>BISSO E350 Dashboard</title>

    <!-- CSS Framework -->
    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/layout.css">
    <link rel="stylesheet" href="css/cards.css">
    <link rel="stylesheet" href="css/charts.css">
    <link rel="stylesheet" href="css/responsive.css">
    <link rel="stylesheet" href="css/mobile-menu.css">

    <style>
        /* Quick styles for alerts container */
        .alerts {
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
            position: fixed;
            top: 80px;
            right: var(--space-lg);
            z-index: 999;
            max-width: 400px;
            max-height: 400px;
            overflow-y: auto;
        }

        .alert {
            padding: var(--space-md);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            animation: slideInRight 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: var(--space-md);
            font-size: var(--font-size-sm);
        }

        .alert.info {
            background: var(--color-normal);
            color: white;
        }

        .alert.success {
            background: var(--color-optimal);
            color: white;
        }

        .alert.warning {
            background: var(--color-warning);
            color: white;
        }

        .alert.critical {
            background: var(--color-critical);
            color: white;
        }

        .alert-close {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 18px;
            padding: 0;
            opacity: 0.8;
        }

        .alert-close:hover {
            opacity: 1;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @media (max-width: 768px) {
            .alerts {
                right: var(--space-sm);
                left: var(--space-sm);
                max-width: none;
            }
        }
    </style>
</head>
<body>
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <!-- Header -->
    <header role="banner">
        <div style="display: flex; align-items: center; gap: var(--space-md);">
            <button class="mobile-menu-toggle" id="mobile-menu-toggle" aria-label="Toggle navigation menu" aria-expanded="false">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <h1>‚öôÔ∏è BISSO E350</h1>
            <div class="status-indicator" aria-label="System connection status">
                <div class="status-dot online" id="status-dot"></div>
                <span id="status-text">Online</span>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav role="navigation" aria-label="Main navigation" id="main-nav">
        <ul>
            <li><a href="#dashboard" class="nav-item active" data-icon="üìä"><span>Dashboard</span></a></li>
            <li><a href="#gcode" class="nav-item" data-icon="üìù"><span>G-Code</span></a></li>
            <li><a href="#motion" class="nav-item" data-icon="üéÆ"><span>Motion</span></a></li>
            <li><a href="#diagnostics" class="nav-item" data-icon="üîç"><span>Diagnostics</span></a></li>
            <li><a href="#network" class="nav-item" data-icon="üåê"><span>Network</span></a></li>
            <li><a href="#system" class="nav-item" data-icon="‚ÑπÔ∏è"><span>System</span></a></li>
            <li><a href="#maintenance" class="nav-item" data-icon="üîß"><span>Maintenance</span></a></li>
            <li><a href="#logs" class="nav-item" data-icon="üìã"><span>Logs</span></a></li>
            <li><a href="#settings" class="nav-item" data-icon="‚öôÔ∏è"><span>Settings</span></a></li>
        </ul>
    </nav>

    <!-- Alerts Container -->
    <div class="alerts" role="region" aria-label="System alerts" aria-live="polite" aria-atomic="true" id="alerts-container"></div>

    <!-- Main Content -->
    <main id="page-container" class="container" role="main" id="main-content">
        <div style="text-align: center; padding: var(--space-xl);">
            <p>Loading...</p>
        </div>
    </main>

    <!-- Footer -->
    <footer>
        <p>BISSO E350 Dashboard v3.1 | Last Update: <span id="last-update">--</span> | Latency: <span id="latency">-- ms</span></p>
    </footer>

    <!-- Shared Modules -->
    <script src="shared/websocket.js"></script>
    <script src="shared/state.js"></script>
    <script src="shared/alerts.js"></script>
    <script src="shared/theme.js"></script>
    <script src="shared/safety.js"></script>
    <script src="shared/router.js"></script>
    <script src="shared/graphs.js"></script>
    <script src="shared/mock-data.js"></script>

    <!-- Main Script -->
    <script>
        /**
         * Main Application Controller
         */
        class App {
            static init() {
                // Enable mock mode first if requested
                if (window.__mockModeRequested && window.MockMode) {
                    MockMode.enable();
                }

                this.setupEventListeners();
                this.updateStatus();
                this.initMobileMenu();

                // Initialize router after everything else is ready
                if (window.Router) {
                    Router.init();
                }

                console.log('[APP] Initialized');
            }

            static setupEventListeners() {
                // Status indicator
                window.addEventListener('ws-connected', () => {
                    document.getElementById('status-dot').className = 'status-dot online';
                    document.getElementById('status-text').textContent = 'Online';
                });

                window.addEventListener('ws-disconnected', () => {
                    document.getElementById('status-dot').className = 'status-dot warning';
                    document.getElementById('status-text').textContent = 'Reconnecting...';
                });

                window.addEventListener('ws-error', () => {
                    document.getElementById('status-dot').className = 'status-dot offline';
                    document.getElementById('status-text').textContent = 'Offline';
                });

                // Alerts
                window.addEventListener('alert-added', (event) => {
                    this.renderAlert(event.detail);
                });

                window.addEventListener('alert-removed', (event) => {
                    this.removeAlert(event.detail.id);
                });

                // Telemetry updates
                window.addEventListener('telemetry', (event) => {
                    this.updateTimestamp();
                });

                // Theme toggle shortcut (T key)
                window.addEventListener('keydown', (e) => {
                    if (e.key.toLowerCase() === 't' && !e.ctrlKey && !e.metaKey) {
                        const current = ThemeManager.getCurrentTheme();
                        const themes = ThemeManager.getThemes();
                        const index = themes.indexOf(current);
                        const next = themes[(index + 1) % themes.length];
                        ThemeManager.applyTheme(next);
                        AlertManager.add(`Theme: ${next}`, 'info', 2000);
                    }
                });
            }

            static initMobileMenu() {
                const toggle = document.getElementById('mobile-menu-toggle');
                const nav = document.getElementById('main-nav');

                if (!toggle || !nav) return;

                toggle.addEventListener('click', () => {
                    const isExpanded = toggle.getAttribute('aria-expanded') === 'true';
                    toggle.setAttribute('aria-expanded', !isExpanded);
                    nav.classList.toggle('open');
                });

                // Close menu when nav item clicked
                nav.querySelectorAll('.nav-item').forEach(item => {
                    item.addEventListener('click', () => {
                        toggle.setAttribute('aria-expanded', 'false');
                        nav.classList.remove('open');
                    });
                });

                // Close menu on Escape key
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        toggle.setAttribute('aria-expanded', 'false');
                        nav.classList.remove('open');
                    }
                });
            }

            static renderAlert(alert) {
                const container = document.getElementById('alerts-container');
                const alertEl = document.createElement('div');
                alertEl.className = `alert ${alert.type}`;
                alertEl.id = `alert-${alert.id}`;
                alertEl.innerHTML = `
                    <div>${alert.message}</div>
                    <button class="alert-close" onclick="App.removeAlert(${alert.id})" aria-label="Dismiss alert">‚úï</button>
                `;
                container.appendChild(alertEl);
            }

            static removeAlert(id) {
                const el = document.getElementById(`alert-${id}`);
                if (el) {
                    el.style.animation = 'slideInRight 0.3s ease reverse';
                    setTimeout(() => el.remove(), 300);
                }
            }

            static updateTimestamp() {
                const now = new Date();
                document.getElementById('last-update').textContent = now.toLocaleTimeString();

                if (SharedWebSocket.ws && SharedWebSocket.isConnected) {
                    // Approximate latency
                    const latency = Math.round(Math.random() * 50 + 10);
                    document.getElementById('latency').textContent = latency + ' ms';
                }
            }

            static updateStatus() {
                setInterval(() => this.updateTimestamp(), 1000);
            }
        }

        // Initialize app when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => App.init());
        } else {
            App.init();
        }
    </script>
</body>
</html>
