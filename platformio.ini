; @file platformio.ini
; @brief Build configuration for BISSO E350 Controller
; @project BISSO E350 Controller
; @author Sergio Faustino
; @hardware KC868-A16 with ESP32-WROOM-32E

[platformio]
default_envs = esp32dev

; ========================================================
; KC868-A16 v1.6 Environment (ESP32-WROOM-32E)
; Compatible with: ESP32-WROOM-32E (no PSRAM)
; Typical boards: KC868-A16 v1.6, NodeMCU, DevKit
; ========================================================
[env:esp32dev]
platform = espressif32
board = esp32dev
framework = arduino
monitor_speed = 115200
upload_speed = 460800

build_flags =
    -Os
    -Wl,--gc-sections
    -ffunction-sections
    -fdata-sections
    -I include/
    -DBOARD_KC868_A16_V16
    -DLOG_LEVEL=LOG_LEVEL_INFO
    -DENABLE_SERIAL_LOGGING=1
    -DFILE_CHUNK_SIZE=2048
    ; ArduinoJson Flash optimizations (disable unused features)
    -DARDUINOJSON_ENABLE_ARDUINO_STRING=1
    -DARDUINOJSON_ENABLE_ARDUINO_STREAM=1
    -DARDUINOJSON_ENABLE_ARDUINO_PRINT=1
    -DARDUINOJSON_ENABLE_PROGMEM=0
    -DARDUINOJSON_ENABLE_COMMENTS=0
    ; SSL/TLS Memory Optimization (Fixes ENOMEM on OTA check)
    ; Reduce default 16KB buffers to 4KB (saves ~24KB RAM)
    -DMBEDTLS_SSL_IN_CONTENT_LEN=6144
    -DMBEDTLS_SSL_OUT_CONTENT_LEN=1024
    ; Note: lwIP TCP settings cannot be overridden via build_flags
    ; in Arduino-ESP32. Use menuconfig/sdkconfig for TCP tuning.
    -Wall
    -Wextra
    -Werror=return-type

upload_protocol = esptool
monitor_filters = default;esp32_exception_decoder
lib_deps =
    bblanchon/ArduinoJson@^7.0.0
    hoeken/PsychicHttp@^2.0.0
    marcoschwartz/LiquidCrystal_I2C@^1.1.4
    marian-craciunescu/ESP32Ping@^1.7

board_build.partitions = partitions.csv
board_build.filesystem = littlefs
board_build.f_flash = 40000000L
board_build.flash_mode = dout

build_src_filter = +<*> -<remote_dro/>

; Exclude test directory from main firmware build
; test_ignore = *

; ========================================================
; ESP32-S3 Environment (alternative, not used)
; Keep for reference if upgrading hardware later
; ========================================================
[env:esp32-s3-devkitc-1]
platform = espressif32
board = esp32-s3-devkitc-1
framework = arduino
monitor_speed = 115200
upload_speed = 921600

build_flags =
    -O2
    -Wl,--gc-sections
    -ffunction-sections
    -fdata-sections
    -I include/
    -DARDUINO_USB_CDC_ON_BOOT=1
    -DARDUINO_USB_MODE=1
    -DLOG_LEVEL=LOG_LEVEL_INFO
    -DENABLE_SERIAL_LOGGING=1
    -DBOARD_HAS_PSRAM
    ; PSRAM & Flash Mode for N16R8 (Octal)
    -mfix-esp32-psram-cache-issue 
    ; Fix for some S3 revisions, harmless on others
    
    ; ArduinoJson Flash optimizations
    -DARDUINOJSON_ENABLE_ARDUINO_STRING=1
    -DARDUINOJSON_ENABLE_ARDUINO_STREAM=1
    -DARDUINOJSON_ENABLE_ARDUINO_PRINT=1
    -DARDUINOJSON_ENABLE_PROGMEM=0
    
    -Wall
    -Wextra
    -Werror=return-type

board_upload.flash_size = 8MB
board_build.partitions = default.csv
board_build.filesystem = littlefs
board_build.arduino.memory_type = qio_opi
board_build.f_flash = 80000000L
board_build.flash_mode = qio

upload_protocol = esptool
monitor_filters = default;esp32_exception_decoder
lib_deps =
    bblanchon/ArduinoJson@^7.0.0
    hoeken/PsychicHttp@^2.0.0
    marcoschwartz/LiquidCrystal_I2C@^1.1.4
    marian-craciunescu/ESP32Ping@^1.7

build_src_filter = +<*> -<remote_dro/>

; ========================================================
; Test Environment (Host-based, native compilation)
; ========================================================
; This environment compiles and runs unit tests on the
; development machine using the native platform
; Pure unit tests only - no Arduino.h dependencies
; ========================================================
[env:test]
platform = windows_x86
test_framework = unity

; Include paths for tests
build_flags =
    -O2
    -Wall
    -Wextra
    -std=c++17
    -I include/
    -I test/
    -I lib/TestMocks/
    -I lib/TestHelpers/
    -DUNITY_INCLUDE_CONFIG_H
    -DUNIT_TEST

; Don't build main src/ for tests
test_build_src = false

; Exclude device-specific tests (require Arduino.h)
test_ignore = device
build_src_filter = -<*>

; Libraries for testing
lib_deps =
    bblanchon/ArduinoJson@^7.0.0

; ========================================================
; ESP32-S2 Environment (New Hardware)
; ========================================================
[env:esp32s2]
platform = espressif32
board = lolin_s2_mini
framework = arduino
monitor_speed = 115200
upload_speed = 460800

build_flags =
    -Os
    -I include/
    -DLOG_LEVEL=LOG_LEVEL_INFO
    -DENABLE_SERIAL_LOGGING=1
    ; Enable native USB CDC for Serial Monitor
    -DARDUINO_USB_CDC_ON_BOOT=1
    -DSerial=USBSerial
    
    ; ArduinoJson optimizations
    -DARDUINOJSON_ENABLE_ARDUINO_STRING=1
    -DARDUINOJSON_ENABLE_ARDUINO_STREAM=1
    -DARDUINOJSON_ENABLE_ARDUINO_PRINT=1
    
    -Wall
    -Wextra

upload_protocol = esptool
monitor_filters = default;esp32_exception_decoder
lib_deps =
    bblanchon/ArduinoJson@^7.0.0
    hoeken/PsychicHttp@^2.0.0
    marcoschwartz/LiquidCrystal_I2C@^1.1.4
    marian-craciunescu/ESP32Ping@^1.7

board_build.filesystem = littlefs
board_build.partitions = partitions.csv

build_src_filter = +<*> -<remote_dro/>

; ========================================================
; KC868-A16 v3.1 Environment (ESP32-S3-N16R8)
; Compatible with: ESP32-S3-WROOM-1U N16R8 (16MB Flash, 8MB PSRAM)
; Features: W5500 Ethernet (WiFi-only for now), DS3231 RTC, SSD1306 OLED
; ========================================================
[env:esp32s3-kc868-a16-v31]
platform = espressif32
board = esp32-s3-devkitc-1
framework = arduino
monitor_speed = 115200
upload_speed = 921600

build_flags =
    -O2
    -Wl,--gc-sections
    -ffunction-sections
    -fdata-sections
    -I include/
    -DBOARD_KC868_A16_V31
    -DLOG_LEVEL=LOG_LEVEL_INFO
    -DENABLE_SERIAL_LOGGING=1
    -DFILE_CHUNK_SIZE=4096
    ; NOTE: USB CDC disabled - using UART0 (GPIO 43/44) for serial output
    ; Re-enable these for KC868-A16 v3.1 which needs USB CDC to free 43/44 for Ethernet
    ; -DARDUINO_USB_CDC_ON_BOOT=1
    ; -DARDUINO_USB_MODE=1
    ; PSRAM: N16R8 has 8MB Octal PSRAM
    -DBOARD_HAS_PSRAM
    ; PSRAM configuration for N16R8 (Octal) - Note: only active if PSRAM chip present
    -mfix-esp32-psram-cache-issue
    ; ArduinoJson optimizations
    -DARDUINOJSON_ENABLE_ARDUINO_STRING=1
    -DARDUINOJSON_ENABLE_ARDUINO_STREAM=1
    -DARDUINOJSON_ENABLE_ARDUINO_PRINT=1
    -DARDUINOJSON_ENABLE_PROGMEM=0
    -Wall
    -Wextra
    -Werror=return-type

upload_protocol = esptool
monitor_filters = default;esp32_exception_decoder
lib_deps =
    bblanchon/ArduinoJson@^7.0.0
    hoeken/PsychicHttp@^2.0.0
    marcoschwartz/LiquidCrystal_I2C@^1.1.4
    marian-craciunescu/ESP32Ping@^1.7

board_upload.flash_size = 16MB
board_build.partitions = default_16MB.csv
board_build.filesystem = littlefs
; N16R8 module has Octal PSRAM - use qio_opi mode
board_build.arduino.memory_type = qio_opi
board_build.f_flash = 80000000L
board_build.flash_mode = dio

build_src_filter = +<*> -<remote_dro/>

; ========================================================
; Remote DRO Receiver Environment
; ========================================================
[env:remote_dro]
platform = espressif32
board = esp32-c3-devkitm-1
framework = arduino
monitor_speed = 115200

build_src_filter = -<*> +<remote_dro/> -<remote_dro/hal/hal_tdisplay.*>

build_flags = 
    -Os
    -I include/
    -DARDUINO_USB_MODE=1
    -DARDUINO_USB_CDC_ON_BOOT=1
    ; Common OLED pins for ESP32-C3 boards from AliExpress
    ; SDA: 5, SCL: 6 (Most likely for this specific board)
    -DOLED_SDA=5
    -DOLED_SCL=6

; Force reset when opening monitor to catch boot logs
monitor_dtr = 1
monitor_rts = 1
monitor_filters = time, esp32_exception_decoder, colorize

lib_deps =
    adafruit/Adafruit SSD1306 @ ^2.5.7
    adafruit/Adafruit GFX Library @ ^1.11.5

board_build.flash_mode = dio

; ========================================================
; Remote DRO - LilyGo T-Display (ESP32)
; ========================================================
[env:remote_dro_tdisplay]
platform = espressif32
board = esp32dev
framework = arduino
monitor_speed = 115200

build_src_filter = -<*> +<remote_dro/> -<remote_dro/hal/hal_supermini.*>

build_flags = 
    -Os
    -I include/
    -DHAL_TDISPLAY=1
    ; TFT_eSPI configuration
    -DUSER_SETUP_LOADED=1
    -DST7789_DRIVER=1
    -DTFT_SDA_READ=1
    -DC_TFT_WIDTH=135
    -DC_TFT_HEIGHT=240
    -DTFT_MOSI=19
    -DTFT_SCLK=18
    -DTFT_CS=5
    -DTFT_DC=16
    -DTFT_RST=23
    -DTFT_BL=4
    -DSPI_FREQUENCY=40000000

monitor_dtr = 1
monitor_rts = 1
monitor_filters = time, esp32_exception_decoder, colorize

lib_deps =
    bodmer/TFT_eSPI @ ^2.5.33
    adafruit/Adafruit GFX Library @ ^1.11.5

; ========================================================
; Remote DRO - LilyGo T-Display (Simulation Mode)
; ========================================================
[env:remote_dro_tdisplay_sim]
extends = env:remote_dro_tdisplay
build_flags = 
    ${env:remote_dro_tdisplay.build_flags}
    -DSIMULATION_MODE=1

